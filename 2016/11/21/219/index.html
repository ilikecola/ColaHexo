<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      在 CentOS 7 上搭建 Cisco AnyConnect VPN | Cola&#39;s Memory 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="ilikecola">
    
    

    <meta name="description" content="因为最近的干扰力度变大，考虑到 AnyConnect 是思科的安全远程接入解决方案，隐蔽性要好一些，所以决定在服务器上搭建 AnyConnect 以提供给 iOS 设备使用，原来的 Cisco IPSec VPN 废弃，Shadowsocks 保留用于安卓和PC的连接。">
<meta property="og:type" content="article">
<meta property="og:title" content="在 CentOS 7 上搭建 Cisco AnyConnect VPN | Cola's Memory">
<meta property="og:url" content="http://colascarlet.moe/2016/11/21/219/index.html">
<meta property="og:site_name" content="Cola's Memory">
<meta property="og:description" content="因为最近的干扰力度变大，考虑到 AnyConnect 是思科的安全远程接入解决方案，隐蔽性要好一些，所以决定在服务器上搭建 AnyConnect 以提供给 iOS 设备使用，原来的 Cisco IPSec VPN 废弃，Shadowsocks 保留用于安卓和PC的连接。">
<meta property="og:updated_time" content="2016-11-21T13:58:05.661Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="在 CentOS 7 上搭建 Cisco AnyConnect VPN | Cola's Memory">
<meta name="twitter:description" content="因为最近的干扰力度变大，考虑到 AnyConnect 是思科的安全远程接入解决方案，隐蔽性要好一些，所以决定在服务器上搭建 AnyConnect 以提供给 iOS 设备使用，原来的 Cisco IPSec VPN 废弃，Shadowsocks 保留用于安卓和PC的连接。">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="stylesheet" href="/css/animsition.min.css">
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed animsition">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        
        <a href="/" title="link to homepage for Cola&#39;s Memory"><img src="/avatar.png" width="80" alt="Cola&#39;s Memory logo" class="panel-cover__logo logo" /></a>
        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">Cola&#39;s Memory</a></h1>
        <hr class="panel-cover__divider" />

        
        <p class="panel-cover__description">
          Just A Memorization
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                  
                    <li id="page-button-home" class="home_navigation__item navigation__item"><a style="cursor:pointer" title="" class="home-button">Home</a></li>
                                 
              
                  
                    <li id="page-button-blog" class="blog_navigation__item navigation__item"><a href="/#blog" title="" class="blog-button">Blog</a></li>
                                 
              
                  
                  	<li id="page-button-about" class="other_navigation__item navigation__item"><a href="/about" title="" class="other-button">About</a></li>
                                 
              
                  
                  	<li id="page-button-records" class="other_navigation__item navigation__item"><a href="/records" title="" class="other-button">Records</a></li>
                                 
              
                  
                  	<li id="page-button-ss" class="other_navigation__item navigation__item"><a href="https://ss.remiliascarlet.tk/auth/login" title="" class="other-button">Shadowsocks</a></li>
                                 
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



<nav class="cover-navigation navigation--social">
  <ul class="navigation">

    
      <!-- Github -->
      <li id="social-button-github" class="navigation__item" style="display:inline-block" >
        <a href="https://github.com/ilikecola" target="_blank" title="ilikecola on GitHub">
          <i class='icon icon-social-github'></i>
          <span class="label">GitHub</span>
        </a>
      </li>
    
    
    <li id="social-button-twitter" class="navigation__item" style="display:inline-block" >
        <a href="https://twitter.com/tkscarlet"  target="_blank" title="ilikecola on Twitter">
          <i class='icon icon-social-twitter'></i>
          <span class="label">Twitter</span>
        </a>
      </li>

    <!-- China social icon -->
    <!--
    
      <li class="navigation__item">
        <a href="" title="">
          <i class='icon cs-icon-douban'></i>
          <span class="label">Douban</span>
        </a>
      </li>
    -->
    
      <li id="social_button-weibo" class="navigation__item" style="display:inline-block" >
        <a href="http://weibo.com/2057404752"  target="_blank" title="ilikecola on Weibo">
          <i class='icon cs-icon-weibo'></i>
          <span class="label">Weibo</span>
        </a>
      </li>





  </ul>
</nav>



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
		
    <div class="animsition content-wrapper-post">
    
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h0 class="post-title">在 CentOS 7 上搭建 Cisco AnyConnect VPN</h0>

    

    <div class="post-meta">
      <time datetime="2016-11-21" class="post-meta__date date">2016-11-21</time> 

      <span class="post-meta__tags tags">

          

          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>因为最近的干扰力度变大，考虑到 AnyConnect 是思科的安全远程接入解决方案，隐蔽性要好一些，所以决定在服务器上搭建 AnyConnect 以提供给 iOS 设备使用，原来的 Cisco IPSec VPN 废弃，Shadowsocks 保留用于安卓和PC的连接。<br><a id="more"></a><br>AnyConnect 有以下优势：<br>1.待机不会断开<br>2.能够下发路由表给客户端（未测试）<br>3.稳定<br>4.耗电量较低</p>
<h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li>安装 ocserv (OpenConnect server)</li>
<li>生成证书</li>
<li>配置 ocserv</li>
<li>配置系统设置</li>
<li>测试</li>
<li>下发路由</li>
</ul>
<h1 id="安装-ocserv-OpenConnect-server"><a href="#安装-ocserv-OpenConnect-server" class="headerlink" title="安装 ocserv (OpenConnect server)"></a>安装 ocserv (OpenConnect server)</h1><p>ocserv 是一个 OpenConnect SSL VPN 协议服务端，0.3.0 版后兼容使用 AnyConnect SSL VPN 协议的终端。<br>官方主页：<a href="http://www.infradead.org/ocserv/" target="_blank" rel="external">http://www.infradead.org/ocserv/</a></p>
<p>ocserv 已经在 epel 仓库中提供了，所以可以直接通过 yum 安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo yum install epel-release</div><div class="line">$ sudo yum install ocserv</div></pre></td></tr></table></figure></p>
<h1 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h1><p>这里你需要先仔细阅读<a href="http://www.infradead.org/ocserv/manual.html#heading5" target="_blank" rel="external">官方文档</a>，简单的来说，如下几步</p>
<h2 id="创建工作文件夹"><a href="#创建工作文件夹" class="headerlink" title="创建工作文件夹"></a>创建工作文件夹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ mkdir anyconnect</div><div class="line">$ cd anyconnect</div></pre></td></tr></table></figure>
<h2 id="生成-CA-证书"><a href="#生成-CA-证书" class="headerlink" title="生成 CA 证书"></a>生成 CA 证书</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ certtool --generate-privkey --outfile ca-key.pem</div><div class="line">$ cat &gt;ca.tmpl &lt;&lt;EOF</div><div class="line">cn = &quot;VPN CA&quot;</div><div class="line">organization = &quot;Big Corp&quot;</div><div class="line">serial = 1</div><div class="line">expiration_days = 3650</div><div class="line">ca</div><div class="line">signing_key</div><div class="line">cert_signing_key</div><div class="line">crl_signing_key</div><div class="line">EOF</div><div class="line">$ certtool --generate-self-signed --load-privkey ca-key.pem \</div><div class="line">--template ca.tmpl --outfile ca-cert.pem</div></pre></td></tr></table></figure>
<p>把生成的 ca-cert.pem 放到 /etc/ocserv/ 中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo mv ca-cert.pem /etc/ocserv/</div></pre></td></tr></table></figure></p>
<h2 id="生成本地服务器证书"><a href="#生成本地服务器证书" class="headerlink" title="生成本地服务器证书"></a>生成本地服务器证书</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ certtool --generate-privkey --outfile server-key.pem</div><div class="line">$ cat &gt;server.tmpl &lt;&lt;EOF</div><div class="line">cn = &quot;www.example.com&quot;</div><div class="line">organization = &quot;MyCompany&quot;</div><div class="line">serial = 2</div><div class="line">expiration_days = 3650</div><div class="line">encryption_key</div><div class="line">signing_key</div><div class="line">tls_www_server</div><div class="line">EOF</div><div class="line">$ certtool --generate-certificate --load-privkey server-key.pem \</div><div class="line">--load-ca-certificate ca-cert.pem --load-ca-privkey ca-key.pem \</div><div class="line">--template server.tmpl --outfile server-cert.pem</div></pre></td></tr></table></figure>
<p>这里的cn项必须对应你最终提供服务的hostname或IP，否则AnyConnect客户端将无法正确导入证书。<br>把生成的 server-cert.pem 和 server-key.pem 放到 /etc/ocserv/ 中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo mv server-cert.pem /etc/ocserv/</div><div class="line">sudo mv server-key.pem /etc/ocserv/</div></pre></td></tr></table></figure></p>
<h2 id="生成客户端证书"><a href="#生成客户端证书" class="headerlink" title="生成客户端证书"></a>生成客户端证书</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ certtool --generate-privkey --outfile client-key.pem</div><div class="line">$ cat &gt;client.tmpl &lt;&lt;EOF</div><div class="line">cn = &quot;some random name&quot;</div><div class="line">unit = &quot;some random unit&quot;</div><div class="line">expiration_days = 3650</div><div class="line">signing_key</div><div class="line">tls_www_client</div><div class="line">EOF</div><div class="line">$ certtool --generate-certificate --load-privkey user-key.pem \</div><div class="line">--load-ca-certificate ca-cert.pem --load-ca-privkey ca-key.pem \</div><div class="line">--template user.tmpl --outfile user-cert.pem</div></pre></td></tr></table></figure>
<p>然后要将证书和密钥转为PKCS12的格式。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">certtool --to-p12 --load-privkey user-key.pem \</div><div class="line">--pkcs-cipher 3des-pkcs12 --load-certificate user-cert.pem --outfile user.p12 --outder</div></pre></td></tr></table></figure></p>
<p>最后，通过 http 服务器或其他方式将 user.p12 传输给客户端导入即可</p>
<h1 id="配置-ocserv"><a href="#配置-ocserv" class="headerlink" title="配置 ocserv"></a>配置 ocserv</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo vim /etc/ocserv/ocserv.conf</div></pre></td></tr></table></figure>
<p>主要修改以下部分<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">#ocserv支持多种认证方式，这是自带的密码认证，使用ocpasswd创建密码文件</div><div class="line">#ocserv还支持证书认证，可以通过Pluggable Authentication Modules (PAM)使用radius等认证方式</div><div class="line">auth = &quot;plain[passwd=/etc/ocserv/ocpasswd]&quot;</div><div class="line">#指定替代的登录方式，这里使用证书登录作为第二种登录方式</div><div class="line">enable-auth = &quot;certificate&quot;</div><div class="line">#证书路径</div><div class="line">server-cert = /etc/ocserv/server-cert.pem</div><div class="line">server-key = /etc/ocserv/server-key.pem</div><div class="line">#ca路径</div><div class="line">ca-cert = /etc/ocserv/ca-cert.pem</div><div class="line">#从证书中提取用户名的方式，这里提取的是证书中的 CN 字段作为用户名</div><div class="line">cert-user-oid = 2.5.4.3</div><div class="line">#最大用户数量</div><div class="line">max-clients = 16</div><div class="line">#同一个用户最多同时登陆数</div><div class="line">max-same-clients = 10</div><div class="line">#tcp和udp端口</div><div class="line">tcp-port = 4433</div><div class="line">udp-port = 4433</div><div class="line">#运行用户和组</div><div class="line">run-as-user = ocserv</div><div class="line">run-as-group = ocserv</div><div class="line">#虚拟设备名称</div><div class="line">device = vpns</div><div class="line">#分配给VPN客户端的IP段</div><div class="line">ipv4-network = 10.12.0.0</div><div class="line">ipv4-netmask = 255.255.255.0</div><div class="line">#DNS</div><div class="line">dns = 8.8.8.8</div><div class="line">dns = 8.8.4.4</div><div class="line">#注释掉route的字段，这样表示所有流量都通过 VPN 发送</div><div class="line">#route = 192.168.1.0/255.255.255.0</div><div class="line">#route = 192.168.5.0/255.255.255.0</div></pre></td></tr></table></figure></p>
<h1 id="配置系统设置"><a href="#配置系统设置" class="headerlink" title="配置系统设置"></a>配置系统设置</h1><h2 id="开启内核转发"><a href="#开启内核转发" class="headerlink" title="开启内核转发"></a>开启内核转发</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo sed -i &apos;s/net.ipv4.ip_forward = 0/net.ipv4.ip_forward = 1/g&apos; /etc/sysctl.conf</div><div class="line">$ sudo sysctl -p</div></pre></td></tr></table></figure>
<h2 id="配置-iptables-规则"><a href="#配置-iptables-规则" class="headerlink" title="配置 iptables 规则"></a>配置 iptables 规则</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#IP段和eth0接口和vpns类接口要根据自己的情况修改</div><div class="line">$ sudo iptables -t nat -A POSTROUTING -s 10.12.0.0/24 -o eth0 -j MASQUERADE</div><div class="line">$ sudo iptables -A FORWARD -i vpns+ -j ACCEPT</div><div class="line">$ sudo iptables -A FORWARD -o vpns+ -j ACCEPT</div><div class="line">$ sudo iptables-save &gt; /etc/sysconfig/iptables</div></pre></td></tr></table></figure>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><p>现在我们可以开启服务器试试了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo ocserv -c /etc/ocserv/ocserv.conf -f -d 1</div></pre></td></tr></table></figure></p>
<p>拿起你的 iOS 设备，下载思科的 AnyConnect 客户端，连接你的服务器。<br>出现问题可以看debug的返回信息，如果信息不详细，可以把 1 改成 10。<br>如果没有问题，那么就可以配置成开机运行了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo systemctl enable ocserv</div><div class="line">$ sudo systemctl start ocserv</div></pre></td></tr></table></figure></p>
<h1 id="下发路由"><a href="#下发路由" class="headerlink" title="下发路由"></a>下发路由</h1><p>我想这个功能是最激动人心的，因为我们手机如果长期连接，那么肯定是某些服务走 VPN，而国内的网站可以走手机自己的网络体验最好。<br>但是这里的一个问题是，AnyConnect 有下发路由表的 64 条数限制。<br>所以我们只能保证下某几个常用的服务是可用的，比如 Google Facebook 以及 Twitter<br>编辑配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo vim /etc/ocserv/ocserv.conf</div></pre></td></tr></table></figure></p>
<p>添加<code>route =</code>的字段即可</p>
<p>Reference:</p>
<blockquote>
<p><a href="http://ifreedomlife.com/2015/04/20/Setup-Cisco-AnyConnect-VPN-on-CentOS7/" target="_blank" rel="external">http://ifreedomlife.com/2015/04/20/Setup-Cisco-AnyConnect-VPN-on-CentOS7/</a><br><a href="https://bitinn.net/11084/" target="_blank" rel="external">https://bitinn.net/11084/</a></p>
</blockquote>

  </section>

  
  
</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2014-2015. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a></span>
    
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    <script src="/js/animsition.min.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                displayNow: true,
                autoDetectHeadings: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
